version: 0.1
component: build
timeoutInSeconds: 1200
runAs: root

steps:
  - type: Command
    name: Check Docker Version
    timeoutInSeconds: 60
    command: |
      echo "Docker version:"
      docker version

  - type: Command
    name: Install Buildx Plugin
    timeoutInSeconds: 180
    command: |
      mkdir -p ~/.docker/cli-plugins
      curl -L https://github.com/docker/buildx/releases/download/v0.11.2/buildx-v0.11.2.linux-amd64 -o ~/.docker/cli-plugins/docker-buildx
      chmod +x ~/.docker/cli-plugins/docker-buildx
      docker buildx version || echo "Buildx not installed correctly"

  - type: Command
    name: Try Buildx Builder
    timeoutInSeconds: 300
    command: |
      export DOCKER_CLI_EXPERIMENTAL=enabled
      docker buildx create --name multiarch-tester --use || echo "Buildx create failed"
      docker buildx inspect --bootstrap || echo "Buildx inspect failed"

  - type: Command
    name: Test Multi-Arch Build
    timeoutInSeconds: 300
    command: |
      echo -e "FROM busybox\nCMD echo 'Hello from ARM64'" > Dockerfile
      docker buildx build --platform linux/arm64 -t test-arm64 . --no-cache --load || echo "Multi-arch build failed"
