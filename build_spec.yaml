version: 0.1
component: build
timeoutInSeconds: 1200
runAs: root

steps:
  - type: Command
    name: Check Docker Version
    timeoutInSeconds: 60
    command: |
      echo "Docker version:"
      docker version

  - type: Command
    name: Install Docker Buildx Plugin
    command: |
      mkdir -p ~/.docker/cli-plugins
      curl -sSL https://github.com/docker/buildx/releases/download/v0.11.2/buildx-v0.11.2.linux-amd64 -o ~/.docker/cli-plugins/docker-buildx
      chmod +x ~/.docker/cli-plugins/docker-buildx
      docker buildx version

  - type: Command
    name: Create Buildx Builder
    command: |
      export DOCKER_CLI_EXPERIMENTAL=enabled
      docker buildx create --name arm64-tester --use
      docker buildx inspect --bootstrap

  - type: Command
    name: Build for ARM64 only
    command: |
      echo 'FROM busybox\nRUN echo "Hello ARM64!"' > Dockerfile
      docker buildx build --platform linux/arm64 -t test/arm64-fail .

